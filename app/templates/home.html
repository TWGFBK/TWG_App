{% extends "base.html" %}

{% block title %}TWG{% endblock %}

{% block content %}

<link rel="stylesheet" href="../static/home.css">
<div class="grid">
    <div>
        <h1>V√§lkommen, {{ session.first_name }} {{ session.last_name }}!</h1>
        
        
        <div id="alarms-container">
        {% if alarms %}
        <h2>Aktiva larm</h2>
        <div class="grid" id="alarms-grid">
            {% for alarm in alarms %}
            <article>
                <header>
                    <h3>
                        {% if alarm[1] == 'real' %}
                            {{ alarm[2] or 'Larm' }}
                        {% elif alarm[1] == 'test' %}
                            {{ alarm[2] or 'Test' }}
                        {% else %}
                            {{ alarm[2] or '√ñvning' }}
                        {% endif %}
                    </h3>
                    <p><strong>{{ alarm[6] }} ({{ alarm[5] }})</strong></p>
                    <p><small>{{ alarm[3]|format_local('%d/%m/%Y %H:%M') }}</small></p>
                    {% set location = None %}
                    {% if alarm[7] %}
                        {% set location = alarm[7] %}
                    {% elif alarm[8] and ';' in alarm[8] %}
                        {% set location = alarm[8].split(';')[0].strip() %}
                    {% endif %}
                    {% if location %}
                    <p style="margin-top: 10px;">
                        <strong>Plats:</strong> {{ location }}
                    </p>
                    <div class="time-buttons" style="margin-top: 10px;">
                        <a href="https://www.google.com/maps/dir/?api=1&destination={{ location|urlencode }}" 
                           target="_blank" 
                           class="maps-button" 
                           title="Visa v√§gbeskrivning i Google Maps">
                            üó∫Ô∏è Visa v√§gbeskrivning
                        </a>
                    </div>
                    {% endif %}
                </header>
                
                {% if (alarm[0], alarm[4]) in attended %}
                <div class="success">
                    ‚úì Du har markerat n√§rvaro
                </div>
                <div class="secondary-buttons">
                    <button class="btn btn-secondary-outline comment-btn" 
                            data-alarm-id="{{ alarm[0] }}" 
                            data-department-id="{{ alarm[4] }}">Frikommentar</button>
                    <button class="btn btn-danger remove-attendance-btn" 
                            data-alarm-id="{{ alarm[0] }}" 
                            data-department-id="{{ alarm[4] }}">Ta bort anm√§lan</button>
                </div>
                <div class="display-button">
                    <a href="/display/{{ alarm[0] }}" class="btn-tertiary">
                        Visa display
                    </a>
                </div>
                {% else %}
                <div class="response-options">
                    <div class="time-buttons">
                        <button class="btn btn-warning time-btn" 
                                data-alarm-id="{{ alarm[0] }}" 
                                data-department-id="{{ alarm[4] }}" 
                                data-arrival-time="5">5 min</button>
                        <button class="btn btn-warning time-btn" 
                                data-alarm-id="{{ alarm[0] }}" 
                                data-department-id="{{ alarm[4] }}" 
                                data-arrival-time="7">7 min</button>
                        <button class="btn btn-warning time-btn" 
                                data-alarm-id="{{ alarm[0] }}" 
                                data-department-id="{{ alarm[4] }}" 
                                data-arrival-time="10">10 min</button>
                        <button class="btn btn-success time-btn" 
                                data-alarm-id="{{ alarm[0] }}" 
                                data-department-id="{{ alarm[4] }}" 
                                data-arrival-time="0">P√• plats</button>
                    </div>
                    <div class="secondary-buttons">
                        <button class="btn btn-secondary-outline custom-time-btn" 
                                data-alarm-id="{{ alarm[0] }}" 
                                data-department-id="{{ alarm[4] }}">Egen tid</button>
                        <button class="btn btn-secondary-outline comment-btn" 
                                data-alarm-id="{{ alarm[0] }}" 
                                data-department-id="{{ alarm[4] }}">Frikommentar</button>
                    </div>
                    <div class="display-button">
                        <a href="/display/{{ alarm[0] }}" class="btn-tertiary">
                            Visa display
                        </a>
                    </div>
                </div>
                {% endif %}
                
            </article>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-alarms-container">
        </div>
        {% endif %}
        </div>
        
    </div>
</div>

<!-- Response Modal -->
<div id="responseModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Markera n√§rvaro</h3>
        <p id="modalMessage"></p>
        
        <div class="comment-section">
            <label for="commentSelect">Snabbkommentar:</label>
            <select id="commentSelect">
                <option value="">V√§lj kommentar...</option>
            </select>
            
            <label for="customComment">Egen kommentar:</label>
            <textarea id="customComment" placeholder="Skriv din egen kommentar..."></textarea>
            
        </div>
        
        <div class="modal-actions">
            <button id="confirmResponse" class="btn btn-primary">Bekr√§fta</button>
            <button id="cancelResponse" class="btn btn-secondary">Avbryt</button>
        </div>
    </div>
</div>

<!-- Custom Time Modal -->
<div id="customTimeModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Egen tid</h3>
        <p>Ange antal minuter:</p>
        
        <div class="custom-time-input-section">
            <input type="number" 
                   id="customMinutesInput" 
                   placeholder="Minuter" 
                   min="1" 
                   max="120"
                   class="custom-minutes-modal-input">
        </div>
        
        <div class="modal-actions">
            <button id="confirmCustomTime" class="btn btn-primary">Bekr√§fta</button>
            <button id="cancelCustomTime" class="btn btn-secondary">Avbryt</button>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle time buttons
    document.querySelectorAll('.time-btn').forEach(button => {
        button.addEventListener('click', function() {
            const alarmId = this.getAttribute('data-alarm-id');
            const departmentId = parseInt(this.getAttribute('data-department-id'));
            const arrivalTime = parseInt(this.getAttribute('data-arrival-time'));
            markAttendanceWithTime(alarmId, departmentId, arrivalTime, this);
        });
    });
    
    // Handle comment buttons
    document.querySelectorAll('.comment-btn').forEach(button => {
        button.addEventListener('click', function() {
            const alarmId = this.getAttribute('data-alarm-id');
            const departmentId = parseInt(this.getAttribute('data-department-id'));
            showCommentModal(alarmId, departmentId, this);
        });
    });
    
    // Handle remove attendance buttons
    document.querySelectorAll('.remove-attendance-btn').forEach(button => {
        button.addEventListener('click', function() {
            const alarmId = this.getAttribute('data-alarm-id');
            const departmentId = parseInt(this.getAttribute('data-department-id'));
            removeAttendance(alarmId, departmentId, this);
        });
    });
    
    // Handle custom time buttons
    document.querySelectorAll('.custom-time-btn').forEach(button => {
        button.addEventListener('click', function() {
            const alarmId = this.getAttribute('data-alarm-id');
            const departmentId = parseInt(this.getAttribute('data-department-id'));
            
            // Store alarm and department IDs for the modal
            document.getElementById('customTimeModal').setAttribute('data-alarm-id', alarmId);
            document.getElementById('customTimeModal').setAttribute('data-department-id', departmentId);
            
            // Clear and show modal
            document.getElementById('customMinutesInput').value = '';
            document.getElementById('customTimeModal').style.display = 'flex';
        });
    });
    
    // Handle custom time modal confirm
    document.getElementById('confirmCustomTime').addEventListener('click', function() {
        const modal = document.getElementById('customTimeModal');
        const alarmId = modal.getAttribute('data-alarm-id');
        const departmentId = parseInt(modal.getAttribute('data-department-id'));
        const minutes = parseInt(document.getElementById('customMinutesInput').value);
        
        if (!minutes || minutes < 1 || minutes > 120) {
            alert('Ange ett giltigt antal minuter (1-120)');
            return;
        }
        
        // Close modal
        modal.style.display = 'none';
        
        // Mark attendance with custom time
        const button = document.querySelector(`.custom-time-btn[data-alarm-id="${alarmId}"][data-department-id="${departmentId}"]`);
        markAttendanceWithTime(alarmId, departmentId, minutes, button);
    });
    
    // Handle custom time modal cancel
    document.getElementById('cancelCustomTime').addEventListener('click', function() {
        document.getElementById('customTimeModal').style.display = 'none';
    });
    
    // Close custom time modal when clicking outside
    document.getElementById('customTimeModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
    
});

let currentAlarmId = null;
let currentDepartmentId = null;
let currentArrivalTime = null;
let isModalOpen = false;

function showResponseModal(alarmId, departmentId, arrivalTime, button) {
    currentAlarmId = alarmId;
    currentDepartmentId = departmentId;
    currentArrivalTime = arrivalTime;
    
    const modal = document.getElementById('responseModal');
    const modalMessage = document.getElementById('modalMessage');
    
    // Set message based on arrival time
    if (arrivalTime === 0) {
        modalMessage.textContent = 'Du markerar att du √§r p√• plats nu.';
    } else {
        modalMessage.textContent = `Du markerar att du kommer om ${arrivalTime} minuter.`;
    }
    
    // Load quick comments
    loadQuickComments();
    
    // Show modal
    modal.style.display = 'flex';
    isModalOpen = true;
    
    // Focus on comment select
    document.getElementById('commentSelect').focus();
}

function loadQuickComments() {
    fetch('/api/quick-comments')
        .then(response => response.json())
        .then(comments => {
            const select = document.getElementById('commentSelect');
            select.innerHTML = '<option value="">V√§lj kommentar...</option>';
            comments.forEach(comment => {
                const option = document.createElement('option');
                option.value = comment.text;
                option.textContent = comment.text;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading quick comments:', error);
        });
}

function confirmResponse() {
    const commentSelect = document.getElementById('commentSelect');
    const customComment = document.getElementById('customComment');
    const isAttendingCheckbox = document.getElementById('isAttending');
    
    let comment = '';
    if (commentSelect.value) {
        comment = commentSelect.value;
    } else if (customComment.value.trim()) {
        comment = customComment.value.trim();
    }
    
    const isAttending = false; // Frikommentar betyder aldrig n√§rvaro
    
    // Always use response endpoint for comments from modal
    const formData = new FormData();
    formData.append('comment', comment);
    formData.append('is_attending', isAttending);
    
    // Frikommentar har aldrig arrival_time
    
    // Debug: log what we're sending
    console.log('Sending comment:', comment);
    console.log('Is attending:', isAttending);
    console.log('Arrival time:', currentArrivalTime);
    
    fetch(`/response/${currentAlarmId}/${currentDepartmentId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response:', data);
        if (data.success) {
            // Close modal
            document.getElementById('responseModal').style.display = 'none';
            isModalOpen = false;
            // Refresh alarms list via AJAX instead of full reload
            refreshAlarmsList();
        } else {
            alert('Fel vid markering av svar: ' + (data.error || 'Ok√§nt fel'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('N√§tverksfel vid markering av svar');
    });
}

function cancelResponse() {
    document.getElementById('responseModal').style.display = 'none';
    isModalOpen = false;
    // Clear form
    document.getElementById('commentSelect').value = '';
    document.getElementById('customComment').value = '';
}

// Event listeners
document.getElementById('confirmResponse').addEventListener('click', confirmResponse);
document.getElementById('cancelResponse').addEventListener('click', cancelResponse);

// Close modal when clicking outside
document.getElementById('responseModal').addEventListener('click', function(e) {
    if (e.target === this) {
        cancelResponse();
    }
});

// Handle comment selection
document.getElementById('commentSelect').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('customComment').value = '';
    }
});

document.getElementById('customComment').addEventListener('input', function() {
    if (this.value.trim()) {
        document.getElementById('commentSelect').value = '';
    }
});

function markAttendanceWithTime(alarmId, departmentId, arrivalTime, button) {
    if (arrivalTime === 0) {
        // "P√• plats" - immediate attendance
        markImmediateAttendance(alarmId, departmentId, button, 0);
    } else {
        // Time-based response - start countdown
        startCountdown(alarmId, departmentId, arrivalTime, button);
    }
}

function startCountdown(alarmId, departmentId, minutes, button) {
    button.disabled = true;
    button.className = 'btn btn-warning';
    
    let remainingSeconds = minutes * 60;
    const originalText = `${minutes} min`;
    
    // Calculate ETA
    const now = new Date();
    const eta = new Date(now.getTime() + (minutes * 60 * 1000));
    const etaString = eta.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
    
    // Mark attendance immediately with ETA
    markImmediateAttendance(alarmId, departmentId, button, minutes, `${minutes} min`);
    
    // Update button text with countdown and ETA
    function updateCountdown() {
        const remainingMinutes = Math.ceil(remainingSeconds / 60);
        button.textContent = `${remainingMinutes} min (ETA: ${etaString})`;
        
        if (remainingSeconds <= 0) {
            // Countdown finished - update to "p√• plats"
            button.textContent = 'P√• plats';
            button.className = 'btn btn-success';
            return;
        }
        
        remainingSeconds--;
        setTimeout(updateCountdown, 1000);
    }
    
    updateCountdown();
}

function markImmediateAttendance(alarmId, departmentId, button, arrivalTime = 0, statusText = '‚úì N√§rvaro markerad') {
    button.textContent = 'Markerar...';
    
    const formData = new FormData();
    formData.append('arrival_time', arrivalTime); // Use provided arrival time
    formData.append('comment', '');
    
    fetch(`/attendance/${alarmId}/${departmentId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Check if response is OK before parsing JSON
        if (!response.ok) {
            // If not OK, try to get error message from JSON
            return response.json().then(data => {
                throw new Error(data.error || 'Server error');
            }).catch(() => {
                throw new Error(`HTTP error! status: ${response.status}`);
            });
        }
        // Try to parse as JSON - if it fails, check if response was successful anyway
        return response.json().catch(error => {
            console.error('JSON parse error:', error);
            // If response was OK but JSON parsing failed, assume success
            if (response.status >= 200 && response.status < 300) {
                console.log('Response OK but not JSON, assuming success');
                return { success: true };
            }
            throw error;
        });
    })
    .then(data => {
        if (data.success) {
            button.textContent = statusText;
            button.className = 'btn btn-success';
            button.disabled = true;
            
            // Redirect to display page for all attendance types
            setTimeout(() => {
                // Find the alarm ID from the button's data attribute
                const alarmId = button.getAttribute('data-alarm-id');
                if (alarmId) {
                    window.location.href = `/display/${alarmId}`;
                } else {
                    // Fallback: refresh alarms list via AJAX
                    refreshAlarmsList();
                }
            }, 1000);
        } else {
            button.textContent = '‚úó Fel';
            button.className = 'btn btn-danger';
            setTimeout(() => {
                button.textContent = arrivalTime === 0 ? 'P√• plats' : `${arrivalTime} min`;
                button.className = arrivalTime === 0 ? 'btn btn-success' : 'btn btn-warning';
                button.disabled = false;
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.textContent = '‚úó N√§tverksfel';
        button.className = 'btn btn-danger';
        setTimeout(() => {
            button.textContent = arrivalTime === 0 ? 'P√• plats' : `${arrivalTime} min`;
            button.className = arrivalTime === 0 ? 'btn btn-success' : 'btn btn-warning';
            button.disabled = false;
        }, 2000);
    });
}

function showCommentModal(alarmId, departmentId, button) {
    currentAlarmId = alarmId;
    currentDepartmentId = departmentId;
    currentArrivalTime = null; // No specific time for free comment
    
    const modal = document.getElementById('responseModal');
    const modalMessage = document.getElementById('modalMessage');
    
    modalMessage.textContent = 'L√§gg till en frikommentar:';
    
    // Load quick comments
    loadQuickComments();
    
    // Show modal
    modal.style.display = 'flex';
    isModalOpen = true;
    
    // Focus on comment select
    document.getElementById('commentSelect').focus();
}

function markAttendance(alarmId, departmentId, button) {
    // This function is kept for backward compatibility
    showCommentModal(alarmId, departmentId, button);
}

function removeAttendance(alarmId, departmentId, button) {
    if (!confirm('√Ñr du s√§ker p√• att du vill ta bort din anm√§lan?')) {
        return;
    }
    
    button.textContent = 'Tar bort...';
    button.disabled = true;
    
    fetch(`/attendance/${alarmId}/${departmentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh alarms list via AJAX instead of full reload
            refreshAlarmsList();
        } else {
            alert('Fel vid borttagning av anm√§lan: ' + (data.error || 'Ok√§nt fel'));
            button.textContent = 'Ta bort anm√§lan';
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('N√§tverksfel vid borttagning av anm√§lan');
        button.textContent = 'Ta bort anm√§lan';
        button.disabled = false;
    });
}

// Function to format alarm kind for display
function formatAlarmKind(kind) {
    if (kind === 'real') return 'Larm';
    if (kind === 'test') return 'Test';
    return '√ñvning';
}

// Function to format date/time
function formatDateTime(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${day}/${month}/${year} ${hours}:${minutes}`;
}

// Function to update alarms list from API data
function updateAlarmsList(data) {
    const container = document.getElementById('alarms-container');
    const alarms = data.alarms || [];
    const attendedSet = new Set(
        data.attended.map(a => `${a.alarm_id}-${a.department_id}`)
    );
    
    if (alarms.length === 0) {
        container.innerHTML = '<div class="no-alarms-container"></div>';
        // No need to attach listeners when there are no alarms
        return;
    }
    
    let html = '<h2>Aktiva larm</h2><div class="grid" id="alarms-grid">';
    
    alarms.forEach(alarm => {
        const alarmKey = `${alarm.id}-${alarm.department_id}`;
        const isAttended = attendedSet.has(alarmKey);
        const location = alarm.location || '';
        const locationUrl = location ? encodeURIComponent(location) : '';
        
        html += '<article>';
        html += '<header>';
        html += `<h3>${alarm.description || formatAlarmKind(alarm.kind)}</h3>`;
        html += `<p><strong>${alarm.department_name} (${alarm.department_code})</strong></p>`;
        html += `<p><small>${formatDateTime(alarm.occurred_at)}</small></p>`;
        
        if (location) {
            html += `<p style="margin-top: 10px;"><strong>Plats:</strong> ${location}</p>`;
            html += '<div class="time-buttons" style="margin-top: 10px;">';
            html += `<a href="https://www.google.com/maps/dir/?api=1&destination=${locationUrl}" target="_blank" class="maps-button" title="Visa v√§gbeskrivning i Google Maps">üó∫Ô∏è Visa v√§gbeskrivning</a>`;
            html += '</div>';
        }
        
        html += '</header>';
        
        if (isAttended) {
            html += '<div class="success">‚úì Du har markerat n√§rvaro</div>';
            html += '<div class="secondary-buttons">';
            html += `<button class="btn btn-secondary-outline comment-btn" data-alarm-id="${alarm.id}" data-department-id="${alarm.department_id}">Frikommentar</button>`;
            html += `<button class="btn btn-danger remove-attendance-btn" data-alarm-id="${alarm.id}" data-department-id="${alarm.department_id}">Ta bort anm√§lan</button>`;
            html += '</div>';
            html += '<div class="display-button">';
            html += `<a href="/display/${alarm.id}" class="btn-tertiary">Visa display</a>`;
            html += '</div>';
        } else {
            html += '<div class="response-options">';
            html += '<div class="time-buttons">';
            html += `<button class="btn btn-warning time-btn" data-alarm-id="${alarm.id}" data-department-id="${alarm.department_id}" data-arrival-time="5">5 min</button>`;
            html += `<button class="btn btn-warning time-btn" data-alarm-id="${alarm.id}" data-department-id="${alarm.department_id}" data-arrival-time="7">7 min</button>`;
            html += `<button class="btn btn-warning time-btn" data-alarm-id="${alarm.id}" data-department-id="${alarm.department_id}" data-arrival-time="10">10 min</button>`;
            html += `<button class="btn btn-success time-btn" data-alarm-id="${alarm.id}" data-department-id="${alarm.department_id}" data-arrival-time="0">P√• plats</button>`;
            html += '</div>';
            html += '<div class="secondary-buttons">';
            html += `<button class="btn btn-secondary-outline custom-time-btn" data-alarm-id="${alarm.id}" data-department-id="${alarm.department_id}">Egen tid</button>`;
            html += `<button class="btn btn-secondary-outline comment-btn" data-alarm-id="${alarm.id}" data-department-id="${alarm.department_id}">Frikommentar</button>`;
            html += '</div>';
            html += '<div class="display-button">';
            html += `<a href="/display/${alarm.id}" class="btn-tertiary">Visa display</a>`;
            html += '</div>';
            html += '</div>';
        }
        
        html += '</article>';
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // Re-attach event listeners after DOM update
    attachEventListeners();
}

// Function to attach event listeners to buttons
function attachEventListeners() {
    // Handle time buttons
    document.querySelectorAll('.time-btn').forEach(button => {
        // Remove old listeners by cloning
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        newButton.addEventListener('click', function() {
            const alarmId = this.getAttribute('data-alarm-id');
            const departmentId = parseInt(this.getAttribute('data-department-id'));
            const arrivalTime = parseInt(this.getAttribute('data-arrival-time'));
            markAttendanceWithTime(alarmId, departmentId, arrivalTime, this);
        });
    });
    
    // Handle comment buttons
    document.querySelectorAll('.comment-btn').forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        newButton.addEventListener('click', function() {
            const alarmId = this.getAttribute('data-alarm-id');
            const departmentId = parseInt(this.getAttribute('data-department-id'));
            showCommentModal(alarmId, departmentId, this);
        });
    });
    
    // Handle remove attendance buttons
    document.querySelectorAll('.remove-attendance-btn').forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        newButton.addEventListener('click', function() {
            const alarmId = this.getAttribute('data-alarm-id');
            const departmentId = parseInt(this.getAttribute('data-department-id'));
            removeAttendance(alarmId, departmentId, this);
        });
    });
    
    // Handle custom time buttons
    document.querySelectorAll('.custom-time-btn').forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        newButton.addEventListener('click', function() {
            const alarmId = this.getAttribute('data-alarm-id');
            const departmentId = parseInt(this.getAttribute('data-department-id'));
            
            document.getElementById('customTimeModal').setAttribute('data-alarm-id', alarmId);
            document.getElementById('customTimeModal').setAttribute('data-department-id', departmentId);
            
            document.getElementById('customMinutesInput').value = '';
            document.getElementById('customTimeModal').style.display = 'flex';
        });
    });
}

// Function to refresh alarms list via AJAX
function refreshAlarmsList() {
    // Only refresh if there are no active forms or interactions
    const activeElement = document.activeElement;
    const isInputElement = activeElement.tagName === 'INPUT' || 
                          activeElement.tagName === 'TEXTAREA' || 
                          activeElement.tagName === 'SELECT';
    
    if (isInputElement || isModalOpen) {
        // Skip refresh if user is interacting
        return;
    }
    
    fetch('/api/active-alarms')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            updateAlarmsList(data);
        })
        .catch(error => {
            console.error('Error refreshing alarms:', error);
            // Silently fail - don't disrupt user experience
        });
}

// Initial attachment of event listeners after page load
attachEventListeners();

// Auto-refresh alarms list every 10 seconds using AJAX
setInterval(refreshAlarmsList, 10000);
</script>
{% endblock %}
